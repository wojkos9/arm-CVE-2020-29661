#include <linux/pid.h>
#include <linux/types.h>
#include <linux/module.h>
#include <linux/printk.h>
#include <linux/fs.h>
#include <linux/cdev.h>
#include <linux/uaccess.h>
#include <linux/device.h>
#include <asm/errno.h>

#include "exm.h"

#define DEV_NAME "exm"

static struct cdev exm_cdev;
static struct class *cls;

static long exm_ioctl(struct file *filp, uint iocn, ulong iocp) {
    switch (iocn) {
        case IOC_PID_ADDR:
        {
            struct pid *pid;
            ulong pid_nr = iocp;
            pid = find_vpid(pid_nr);
            return (ulong)pid;
        }
        case IOC_PID_REFCNT:
        {
            struct pid *pid = (struct pid *)iocp;
            return pid->count.counter;
        }
    }
    return 0;
}

static struct file_operations exm_fops = {
    .owner = THIS_MODULE,
    .unlocked_ioctl = exm_ioctl
};

int init_module(void) {
    int ret;
    printk(KERN_INFO "Init exploit module2\n");
    ret = register_chrdev(EXM_MAJOR, DEV_NAME, &exm_fops);
    if (ret == -1) {
        printk(KERN_ERR "Error registering device");
        return ret;
    }
    cls = class_create(THIS_MODULE, DEV_NAME);
    device_create(cls, NULL, MKDEV(EXM_MAJOR, 0), NULL, DEV_NAME);
    return 0;
}

void cleanup_module(void) {
    device_destroy(cls, MKDEV(EXM_MAJOR, 0));
    class_destroy(cls);
    unregister_chrdev(EXM_MAJOR, DEV_NAME);
}


MODULE_LICENSE("GPL");
