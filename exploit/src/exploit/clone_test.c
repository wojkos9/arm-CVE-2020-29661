#include "uapi/asm/unistd.h"
#define _GNU_SOURCE
#include <unistd.h>
#include <sched.h>
#include <stdio.h>
#include <stdlib.h>
#include <sys/mman.h>
#include <err.h>
#include <sys/syscall.h>
#include <signal.h>
#include <pthread.h>

#include "exm.h"


void* worker(void *p) {
    write(1, "worker\n", 7);
    return NULL;
}

int main() {
    pid_t child;
    unsigned long flags = CLONE_VM|CLONE_FS|CLONE_FILES|CLONE_SIGHAND|CLONE_THREAD|CLONE_SYSVSEM|CLONE_DETACHED;
    void *stack = mmap(NULL, 0x23000, PROT_READ | PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0);
    // pthread_t thread;
    // pthread_create(&thread, NULL, worker, NULL);
    // pthread_join(thread, NULL);
    child = SYSCHK(syscall(__NR_clone, flags, stack + 0x20000, NULL, 0, NULL));
    if (child == 0) {
        worker(NULL);
        exit(0);
    }
    pause();
    return 0;
}